# NAT

> NAT 英文全称是 “Network Address Translation”，中文意思是“网络地址转换”，它是一个 IETF(Internet Engineering Task Force, Internet 工程任务组) 标准，允许**一个**整体机构以**一个公用 IP**（Internet Protocol）地址出现在 Internet上。
> 顾名思义，它是一种把内部私有网络地址（IP 地址）翻译成合法网络 IP 地址的技术。
> 因此我们可以认为，NAT 在一定程度上，能够有效的解决公网地址不足的问题。

NAT 有三种类型：静态 NAT（Static NAT）、动态地址 NAT（Pooled NAT）、网络地址端口转换NAPT（Port-Level NAT）。

## 网络地址端口转换NAPT

网络地址端口转换 NAPT（Network Address Port Translation）则是把内部地址映射到外部网络的一个 IP 地址的**不同端口上**。
它可以将中小型的网络隐藏在一个合法的 IP 地址后面。NAPT 与 动态地址 NAT 不同，它将内部连接映射到外部网络中的一个单独的 IP 地址上，同时在该地址上加上一个由 NAT 设备选定的端口号。

NAPT 是使用最普遍的一种转换方式，在 HomeGW 中也主要使用该方式。它又包含两种转换方式：SNAT 和 DNAT。

- 源 NAT（Source NAT，SNAT）：修改数据包的源地址。
  源 NAT 改变第一个数据包的来源地址，它永远会在数据包发送到网络之前完成，数据包伪装就是一具 SNAT 的例子。

- 目的 NAT（Destination NAT，DNAT）：修改数据包的目的地址。
  Destination NAT 刚好与 SNAT 相反，它是改变第一个数据懈的目的地地址，如平衡负载、端口转发和透明代理就是属于 DNAT。

### 应用

NAT 主要可以实现以下几个功能：数据包伪装、平衡负载、端口转发和透明代理。

- 数据伪装: 
  可以将内网数据包中的地址信息更改成统一的对外地址信息，不让内网主机直接暴露在因特网上，保证内网主机的安全。同时，该功能也常用来实现共享上网。

- 端口转发: 
  当内网主机对外提供服务时，由于使用的是内部私有 IP 地址，外网无法直接访问。因此，需要在网关上进行端口转发，将特定服务的数据包转发给内网主机（外网主动访问内网的情况，外网用户必须要知道访问那个端口可以跳到要访问的主机上）。

- 负载均衡: 
  目的地址转换 NAT 可以重定向一些服务器的连接到其他随机选定的服务器。

- 失效终结: 
  目的地址转换 NAT 可以用来提供高可靠性的服务。如果一个系统有一台通过路由器访问的关键服务器，一旦路由器检测到该服务器当机，它可以使用目的地址转换 NAT 透明的把连接转移到一个备份服务器上。

- 透明代理: 
  NAT 可以把连接到因特网的 HTTP 连接重定向到一个指定的 HTTP 代理服务器以缓存数据和过滤请求。一些因特网服务提供商就使用这种技术来减少带宽的使用而不用让他们的客户配置他们的浏览器支持代理连接。

## 静态NAT

相比之下，静态 NAT 和动态 NAT 用的不算多。

静态转换 （Static Nat） 是指将内部网络的私有 IP 地址转换为公有 IP 地址，IP 地址对**是一对一的**，是**一成不变的**，某个私有 IP 地址只转换为某个公有 IP 地址。
借助于静态转换，可以实现外部网络对内部网络中某些特定设备(如服务器)的访问。 

我个人理解，这种方案仅仅可以使一台主机与外网互通，但是它可以组件一个内网环境，内网之间的主机可以互相通信。

## 动态NAT

动态转换 （Dynamic Nat） 是指将内部网络的私有 IP 地址转换为公用 IP 地址时，IP 地址对是不确定的，而是随机的，所有被授权访问 Internet 的私有 IP 地址可**随机转换**为任何指定的合法 IP 地址。

也就是说，只要指定哪些内部地址可以进行转换，以及用哪些合法地址作为外部地址时，就可以进行动态转换（动态就在这内部维护的“对应表”上）。
动态转换可以使用多个合法外部地址集。当 ISP 提供的合法 IP 地址**略少于**网络内部的计算机数量时。可以采用动态转换的方式。 

## 结语

可以看出 NAT 这技术是工作在较为底层的网络协议上，操作的是数据包，当然网络的分层也仅仅是逻辑上的概念，所以 NAT 技术你既可以使用物理硬件来做，例如路由器之类；也可以是应用软件来做，~~例如各种代理软件~~，不用死板的认为涉及到数据包的处理就得是硬件干的活。

当然，具体到 NAT，因为它的功用性，一般是在物理层面做的，例如路由器上，毕竟它的主要作用就是让多台电脑使用一个共用 IP 来上网。

如果你使用过虚拟机，大概也能理解你可以给虚拟机设置 NAT 上网方式，这样你的主机就相当于一个 NAT 设备了，这样就不需要其他的物理设备。

---

无论你几个主机使用一个 IP，只要用路由器，总是绕不开 NAT，因为你的网络肯定要分内网和外网，你连上路由器分配的就是一个内网地址，这样你发的所有数据包源地址都是一个内网地址，所以必须要 NAT，除非你是直接怼了 WAN 口的网线，用宽带拨号上网。

# 桥接

家庭无线路由器的 LAN 口，任意选取其中的两个，每个 LAN 口连接一台电脑 A、B，两个 LAN 口就是**桥接关系**，从 A 发出的以太帧，原封不动地到达 B，反之亦然。

桥设备几乎什么都没有做，除了学习 A、B 的 MAC 地址并动态绑定在 LAN 口，并在转发帧时查询此种绑定关系。

更简单的理解，你用一根网线把两个局域网连起来，这就是桥接，即桥接可以互联 LAN。

PS：说到虚拟机，如果使用桥接方式，那么就是相当于使用你真实的网卡（区别与你本机与虚拟机接在一个交换机上），你拔了网线，虚拟机与你本机都提示网络电缆被拔出，就酱。

同时，如果把一个设备放在网关后面，做桥接，这不就是防火墙吗？

### 进一步了解

桥接还可以将一个拥挤的以太网段分割成两部分，原来网段上的流量被分割成两个较小的流量，因此减少了发生冲撞的机会。

协议层面，桥接作用于数据链路层，**使用 MAC 地址作出转发决定**。桥接的网络位于一个单独的逻辑网络地址空间之内。因此，桥接有助于节省网络层地址。因为只有一个逻辑网络存在，**网桥必须将本地广播转发到除源网段外的所有连接的网段**。

> 路由器使用网络地址（IP）来进行工作

想要完全理解，必须得了解它的 MAC 学习模式（有一个桥接表），因为不需要使用路由，采用广播的方式，数据包会广播给每一台主机，相当于村里所有的门都叫了一遍，地址对了你就进去了，我瞎猜的。

继续下去，你还会了解到一个叫 ARP 的东西。

参考：http://wenda.tianya.cn/question/013075c4a3fbc49b