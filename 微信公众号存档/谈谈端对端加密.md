今天继续来聊聊端对端加密，根据 Wiki 的介绍：

> 它是一个**只有参与通讯的用户**可以读取信息的通信系统。总的来说，它可以防止潜在的窃听者（**包括电信供应商、互联网服务供应商甚至是该通讯系统的提供者**）获取能够用以解密通讯的密钥。
> 
> 此类系统被设计为可以防止潜在的监视或篡改企图，因为没有密钥的第三方难以破译系统中传输或储存的数据。举例来说，使用端到端加密的通讯提供商，将无法将其客户的通讯数据提供给 XX。

下面说说我自己的理解，原理上其实和 https 协议差不多，主要是 TLS，这个之前应该讲过：关于SSL/TLS，熟悉 https 的都懂。

这里简单说下流程就是：

1. 对等协商支持的密钥算法
2. 基于非对称密钥的信息传输加密和身份认证、基于 PKI 证书的身份认证
3. 基于对称密钥的数据传输保密

第一点不需要多说，就是双方需要商量一下支持什么加密类型，这个是公开的，不存在什么安全问题。

第二点就是重点了，通过第一步，俩人商量出了一个非对称加密方案，各自生成一对公钥和私钥，然后将公钥发给对方，确认后双方开始用私钥加密信息，最终确定出一个对称加密的密钥。

双方完成确认后，之后的信息开始使用这个对称加密的密钥发送与接收。

**Q：为什么一开始不使用对称加密？**

A：对称加密，说白了就是双方用一个密码，用它来加密和解密消息；既然用一个，就得双方都知道，那么其中一个人如何安全的把它从网络传递给另一个人，这就是个问题了。

**Q：非对称加密如何运作？**

A：双方都需要生成**一对**密钥，分为公钥和私钥，公钥加密的内容只能私钥来解密，反之亦然；这样通信双方首先交换公钥，然后使用对方的公钥加密信息；这样正常情况下，加密的信息只有对方可以解密，因为我们使用的是对方的公钥，而私钥在对方手里并没有公开。

**Q：为什么最终要使用对称加密而不是使用第二步的非对称加密？**

A：主要是效率问题，非对称加密虽然很安全，但是加密与解密的速度太慢，所以，第二步中的非对称密钥只是为了传输**随机生成**的对称加密密钥，为了确保安全完整的将密钥传递给对方，所以使用非对称加密。

**Q：第二步中，双方传递公开密钥的时候被掉包怎么办？**

A：在第二步中，要想保证信息只有对方可以解密，就要保证第一步中拿到的是对方的公钥，如何保证呢？是通过数字证书签名，简单说就是一个网站向权威机构申请证书，公钥被签发在证书上，浏览器接收到会自动比对证书的合法性，因为浏览器内置了权威机构的证书样本，这个是可以比对的。

所以，在 https 中，浏览器是一个重要角色，如果你下了一个不知名的浏览器，这个浏览器内含的证书都是假的，那么也是没有安全性可言的；或者有些网站让你下一个文件，你打开后提示导入证书，如果不清楚是干嘛的，就别乱导了。

## 中间人攻击

这个就是 https 中证书所防范的，例如，我是 A 网络的上层（例如 A 连接了我的 Wi-Fi，我可以控制路由器），A 跟 B 想建立安全连接，根据上面的步骤，在 A B 传递公钥的时候，我偷偷的把 A 给 B 的公钥调包成我自己的给 B，然后把 B 传过来的公钥也调包成我的给 A；

在 A B 传递信息的时候，如果 B 给 A 传，因为这时候 B 使用的是我调包的公钥（B 却认为是 A 的），直接发给 A 的话，A 手里的私钥是解不了的，A 肯定就不信这次通信是安全的。

但是我在中间先拦截 B 给 A 的信息，然后解密（B 手里其实是我的公钥，所以我能解密）看看里面是啥，然后再用之前拦截下的 A 的公钥重新加密，发给 A，整个过程 A 不知道，就认为是安全的。

总结一下就是，A 以为在跟 B 通信，其实是在跟我这个中间人通信，只是我把 A 发的信息解密看一下，然后重新加密转发给 B。

AB 的视角：A <----> B

我的视角：A <----> 我 <----> B

而浏览器内置证书就解决了调包的可能，对于一个网站，我个人没有控制权，是签发不了权威机构的证书的，浏览器自然就不认。

## 端对端加密

然而，例如微信聊天这种，不经过浏览器，默认情况下也就没法保证是否存在中间人，当然微信也根本没有启用端对端加密，但是加密肯定是有的，可能是密钥在服务器存着，进行统一加密，不在双方客户端里，自然也不是端对端加密。

不过有些 App 是有这个功能的，例如电报、iMessage，所以据说 Apple 说 iMessage 的信息它也解不了，因为密钥是双方客户端来处理的，不经过服务器，不过这个很牵强，~~毕竟 iMessage 国内可以用~~。

iMessage 就算确实是启用了端对端加密，但是你别忘了存在 iCloud 这个东西，要想多端同步信息，基本上肯定是需要解密上传的，同步过程可能还有另外的加密处理，不过可能使用的多组密钥同时解密，就是如果光 Apple 自己手里的密钥无法解密，如果 Apple + 用户 就可以解密，如果用户不给授权，那它确实没法解密，但是国内嘛，指不定还有没有第三个密钥，只要凑够任意两个即可解密，这样。

最后说说电报，它是可以端对端加密的，这种模式下信息不经过服务器，因为开源这个是可以求证的，在建立通信时，双方先进行密钥交换，确认后可进行私密通信。

那么问题来了，这种情况下密钥的交换过程如何保证不被调包？当然也可以使用证书或者受信任的网络，更普遍的方式是设备指纹，简单说就是个字符串，你但通信方也应该是一样的，因为这个指纹不会经过本次的网络连接传输，所以即使存在中间人也无法获得，你可以跟你的朋友通过其他渠道来对比这个指纹是否一致，如果一致，那基本可以保证不存在中间人。

在电报私密聊天中，详细信息里可以查看指纹，双方进行比对，iMessage 嘛，就没有这个入口了，虽然宣称使用了端对端加密，在不启用 iCloud 同步的情况下，还真有可能。
