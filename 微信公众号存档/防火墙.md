防火墙就是一种过滤塞（目前你这么理解不算错），你可以让你喜欢的东西通过这个塞子，别的玩意都统统过滤掉。在网络的世界里，要由防火墙过滤的就是承载通信数据的通信包。

其实就是为了阻止不明身份的人访问我们的电脑，或者帮忙阻止我们访问危险的电脑。

天下的防火墙至少都会说两个词：Yes 或者 No；直接说就是接受或者拒绝。

大多数防火墙采用的技术和标准可谓五花八门；这些防火墙的形式多种多样：

- 有的取代系统上已经装备的 TCP/IP 协议栈；
- 有的在已有的协议栈上建立自己的软件模块；
- 有的干脆就是独立的一套操作系统；
- 还有一些应用型的防火墙只对特定类型的网络连接提供保护（比如 SMTP 或者 HTTP 协议等）；
- 还有一些基于硬件的防火墙产品其实应该归入安全路由器一类。

以上的产品都可以叫做防火墙，因为他们的工作方式都是一样的：分析出入防火墙的数据包，决定放行还是把他们扔到一边。 

研究防火墙，只要降低到数据包这层就够了，再往下也没必要了，不管什么文件或者指令最终都是要通过数据包来在网络上传输。

## IP过滤

**所有的防火墙都具有 IP 地址过滤功能**。这项任务要检查 IP 包头，根据其 IP 源地址和目标地址作出放行/丢弃决定。

如果判断符合了过滤规则，那么防火墙就直接进行丢弃了，“心肠”比较好的防火墙还会通知客户程序一声呢！

由于黑客们可以采用 **IP 地址欺骗技术**，伪装成合法地址的计算机就可以穿越信任这个地址的防火墙了；

不过根据地址的转发决策机制还是最基本和必需的，另外要注意的一点是，不要用 DNS 主机名建立过滤表，对 DNS 的伪造比 IP 地址欺骗要容易多了（之前我们谈过 DNS 污染与 DNS 劫持）。

> 也许你用过破解版的软件，它们有的是根据请求指定的一台服务器来验证你的密钥是否是合法的，导致过一段时间你用的密钥就被封了；
>
> 于是很多都是在本地 host 或者防火墙之类的软件将这个 ip 或者域名（这个就不用考虑 DNS 安全问题了）加入黑名单，这样它没法验证，你就一直可用。

## 端口过滤

仅仅依靠地址进行数据过滤在实际运用中是不可行的，还有个原因就是目标主机上往往运行着多种通信服务，比方说，我们不想让用户采用 telnet 的方式连到系统，但这绝不等于我们非得同时禁止他们使用 SMTP/POP 邮件服务器吧？所以说，在地址之外我们还要对服务器的 TCP/ UDP 端口进行过滤。

> 如果不明白，关于端口、TCP/UDP 的相关知识请自行补充。
>
> 简单说，一个端口对应着一个应用，一个应用可以开多个端口，所有的通信协议基本都是依赖 TCP 或者 UDP 来发送数据包。

TCP/IP 是一种端对端协议，每个网络节点都具有唯一的地址。网络节点的应用层也是这样，处于应用层的每个应用程序和服务都具有自己的对应“地址”，也就是端口号。

**地址和端口都具备了才能建立客户机和服务器的各种应用之间的有效通信联系**，地址 + 端口号 能让其他计算机确定是在跟谁的哪一个程序通信，相应的返过来也一样。

由于历史的原因，几乎所有的 TCP/IP **客户程序**都使用大于 1023 的随机分配端口号。

只有 UNIX 计算机上的 root 用户才可以访问 1024 以下的端口，而这些端口还**保留为服务器上的服务所用**。所以，除非我们让所有具有大于 1023 端口号的数据包进入，否则各种网络应用都没法正常工作。 

> 举个例子，你用浏览器访问一台服务器提供的 web 服务，很显然你通过 IP 或者域名加 80 端口就可以确定它，这时候浏览器会发起一个请求，目标地址是 xxx.com:80，那么我们的地址就是 ip + 随机大于 1023 的端口；
>
> 服务器处理完成，把响应通过我们带过去的 ip 地址与那个随机端口号传过来，我们接收完毕后，这条 TCP 网络线路就算完成了，端口号就可以回收了，毕竟 HTTP 是无状态的。

这对防火墙而言可就麻烦了，如果阻塞入站（就是进入防火墙的意思）的全部端口，那么所有的客户机都没法使用网络资源。

不过限制 1023 以下的部分端口是可行的，例如 3389 这种高危端口，但是也不能全部打死，因为像 FTP 这种系统服务使用的端口是小于 1023 的。

对于服务器，一般就直接采用白名单模式，开了那些服务就放行那些端口入站，出站一般默认是全开的，因为你不知道客户机用那个端口向你发请求。

不过这样依然有很多端口映射、内网穿透、端口复用工具来给你的防火墙“松土”，这个我们以后再谈，毕竟安全攻防是个持久战，一直在此消彼长。

> 所谓的标准端口，也仅仅是一个标准，大部分 web 服务都是用 80 端口，你就可以信任 80 端口了么？
>
> 某些 hack 工具就是跑在 80 端口上你也没办法，做测试的时候你 web 服务放在其他端口也没啥问题啊~
>
> 所以，要想信任某个端口，前提是所有人都遵守端口使用规范的情况下，但这是不可能的。

## 检查ACK

源地址我们不相信，源端口也信不得了，这个不得不与黑客共舞的疯狂世界上还有什么值得我们信任呢？还好，事情还没到走投无路的地步。对策还是有的，**不过这个办法只能用于 TCP 协议**。

TCP 是一种可靠的通信协议，“可靠”这个词意味着协议具有包括纠错机制在内的一些特殊性质。为了实现其可靠性，每个 TCP 连接都要先经过一个“握手”过程来交换连接参数。还有，每个发送出去的包在后续的其他包被发送出去之前必须获得一个确认响应。

但并不是对每个 TCP 包都非要采用专门的 ACK 包来响应，实际上仅仅在 TCP 包头上设置一个专门的位就可以完成这个功能了。所以，**只要产生了响应包就要设置 ACK 位**。

**连接会话的第一个包不用于确认，所以它就没有设置 ACK 位，后续会话交换的 TCP 包就要设置 ACK 位了**。

---

举个例子，PC 向远端的 Web 服务器发起一个连接，它生成一个没有设置 ACK 位的**连接请求包**。

当服务器响应该请求时，服务器就发回一个设置了 ACK 位的数据包，同时在包里标记从客户机所收到的字节数。然后客户机就用自己的响应包再响应该数据包，这个数据包也设置了 ACK 位并标记了从服务器收到的字节数。

通过监视 ACK 位，我们就可以**将进入网络的数据限制在响应包的范围之内**。于是，服务器根本无法发起 TCP 连接但却能响应收到的数据包了（针对服务器）。

> 假设我们服务器是提供 web 服务的，我们进行 ACK 检查，将没有 ACK 的 TCP 全部拒绝出站。
>
> 这样既不影响响应客户端的数据，也能阻挡服务器发起的某些不友好的请求。

这套机制还不能算是无懈可击，简单地举个例子，假设我们有台内部 Web 服务器做反代，那么就没办法用了。

还有，对 UDP 包而言就没法监视 ACK 位了，因为 UDP 包压根就没有 ACK 位。还有一些 TCP 应用程序，比如 FTP 连接就必须由这些服务器程序自己发起。 

### FTP带来的困难

一般的 Internet 服务对所有的通信都只使用**一对**端口号，FTP 程序在连接期间则使用**两对**端口号。

第一对端口号用于 FTP 的“命令通道”提供登录和执行命令的通信链路，而另一对端口号则用于 FTP 的“数据通道”提供客户机和服务器之间的文件传送。 

在通常的 FTP 会话过程中，客户机首先向服务器的端口 21（命令通道）发送一个 TCP 连接请求，然后执行 LOGIN、DIR 等各种命令。

一旦用户请求服务器发送数据，FTP 服务器就用其 20 端口 (数据通道)向客户的数据端口发起连接。

问题来了，如果服务器向客户机发起传送数据的连接，那么它就会发送没有设置 ACK 位的数据包，防火墙则按照刚才的规则拒绝该数据包同时也就意味着数据传送没戏了。

通常只有高级的、也就是够聪明的防火墙才能看出客户机刚才告诉服务器的端口，然后才许可对该端口的入站连接。 

### UDP端口过滤

好了，现在我们回过头来看看怎么解决 UDP 问题。刚才说了，UDP 包没有 ACK 位所以不能进行 ACK 位过滤。

UDP 是发出去不管的“不可靠”通信，这种类型的服务通常用于广播、路由、多媒体等广播形式的通信任务。

看来最简单的可行办法就是不允许建立入站 UDP 连接。防火墙设置为只许转发来自内部接口的 UDP 包，来自外部接口的 UDP 包则不转发。

现在的问题是，比方说，DNS 名称解析请求就使用 UDP，如果你提供 DNS 服务，至少得允许一些内部请求穿越防火墙。

对于必须要使用的情况下，我们能做的就是对那些从本地到可信任站点之间的连接进行限制。但是，什么叫可信任！如果黑客采取地址欺骗的方法不又回到老路上去了吗？ 

有些新型路由器可以通过“记忆”出站 UDP 包来解决这个问题：

> 如果入站 UDP 包匹配最近出站 UDP 包的目标地址和端口号就让它进来。如果在内存中找不到匹配的 UDP 包就只好拒绝它了！

但是，我们如何确信产生数据包的外部主机就是内部客户机希望通信的服务器呢？如果黑客诈称 DNS 服务器的地址，那么他在理论上当然可以从附着 DNS 的 UDP 端口发起攻击。只要你允许 DNS 查询和反馈包进入网络这个问题就必然存在。办法是采用代理服务器。 

所谓代理服务器，顾名思义就是代表你的网络和外界打交道的服务器。代理服务器不允许存在任何网络内外的直接连接。它本身就提供公共和专用的 DNS、邮件服务器等多种功能。

代理服务器重写数据包而不是简单地将其转发了事。给人的感觉就是网络内部的主机都站在了网络的边缘，但实际上他们都躲在代理的后面，露面的不过是代理这个假面具。 

代理服务器也就是常说的边缘网络之一。

## 代理服务器

代理服务器技术 ： SOCKS 协议（前面刚发过介绍文章），大概在 1990 年左右出现，其原理是把所有的数据包都拦下来，全部交给代理服务器，由代理服务器把所有包的封装去掉，**进行应用层数据的检查，再重新封装**，应用层没问题才转发到内网之中。

例如堡垒机，类似于主机的东西，靠里边的软件来做检查。

优点就是可以对应用层进行检查，缺点嘛，**工作的效率比包过滤防火墙都低**

## 关于IP欺骗

IP 地址可能是假的，这是由于 IP 协议的**源路由**机制所带来的，这种机制告诉路由器不要为数据包采用正常的路径，而是按照包头内的路径传送数据包。

于是黑客就可以绕过 IP 检查获得返回的数据包。有些高级防火墙可以让用户禁止源路由。通常我们的网络都通过一条路径连接 ISP，然后再进入 Internet。这时禁用源路由就会迫使数据包必须沿着正常的路径返回。 

## 其他

我们需要了解防火墙在拒绝数据包的时候还做了哪些其他工作。比如，防火墙是否向连接发起系统发回了“主机不可到达”的 ICMP 消息？或者防火墙真没再做其他事？

这些问题都可能存在安全隐患。ICMP “主机不可达”消息会告诉黑客“防火墙专门阻塞了某些端口”，黑客立即就可以从这个消息中闻到一点什么气味。

如果 ICMP “主机不可达”是通信中发生的错误，那么老实的系统可能就真的什么也不发送了。

但是反过来，什么响应都没有却会使发起通信的系统不断地尝试建立连接直到应用程序或者协议栈超时，结果最终用户只能得到一个错误信息。当然这种方式会让黑客无法判断某端口到底是关闭了还是没有使用。

## 拓展

- [次世代防火墙](https://zh.wikipedia.org/wiki/%E6%AC%A1%E4%B8%96%E4%BB%A3%E9%98%B2%E7%81%AB%E7%89%86)
- [防火墙基础](http://www.nowamagic.net/academy/detail/72150512)
- [了解防火墙的发展进程及基本原理](https://blog.csdn.net/ZhangPengFeiToWinner/article/details/84400693)
- [ACL（访问控制列表）](https://zhuanlan.zhihu.com/p/39191464)