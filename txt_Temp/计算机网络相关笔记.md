# 计算机网络相关笔记

> 《计算机网络，自顶向下方法》

在 TCP 报文段的首部中，数据偏移的最大值即 TCP 首部的最大长度为 60 个字节。

以太网的 MAC 协议提供的是无连接不可靠的服务。

---

Http 使用 TCP 作为它的支撑运输协议，TCP 提供了可靠的传输，所以 HTTP 不需要担心发送的数据会丢失。

TCP 需要三次握手，发生在运输层，对于客户和服务器程序是完全透明的。

因为 HTTP 服务器不保存用户的任何信息，所以说它是一个无状态协议（非持续连接的HTTP 和持续连接的 HTTP）。

HTTP 的默认模式是使用带流水线的持续连接（一个接一个的发送请求而不必等待末决请求）。

![](./img/tcp握手.jpg)

TODO：TCP 三次/四次握手

---

HTTP 报文中：

首部行 host:www.bfchengnuo.com 指明了对象所在的主机，这是 Web 代理高速缓存所要求的。

Connection: close ，告诉服务器不需要使用持续连接，要求服务器在发送完数据后就关闭这个连接。

---

## Web缓存器

Web缓存器也叫代理服务器，能提高访问速度，减轻高并发的压力，随着内容分发网络（CDN）的大量使用，Web缓存器正在因特网中发挥着越来越重要的作用。

HTTP 协议有一种机制，允许缓存器证实它的对象是最新的，这种机制就是条件 Get，举个栗子：

用户通过浏览器向代理缓存器请求数据，代理缓存器发现没有数据，就向真实web服务器请求数据。

然后代理缓存器将数据返回给客户端，同时本地也缓存了该数据，同时记录了最后的修改日期（Last-Modified）。

一段时间后，用户再次请求这个数据，代理缓存器使用条件 Get 查询数据是否已经改变，通过在头信息中加入 If-Modified-Since，值就是当时记录的最后修改时间，真实的web服务器收到后会检查此文件是否发生了改变，如果没有发生改变会返回一个 304 Not Modified （没有数据体，报文非常小），告诉缓存器可以使用该对象（数据）。

使用 HTTP 传送前，不需要将多媒体数据编码为 ASCII。

---

FTP 协议会建立两条TCP连接（21-控制连接，20-数据连接），对FTP传输而言，控制连接贯穿整个用户会话期间，数据连接是非连续的，传送完一个文件会关闭该连接。

---

## 电子邮件

电子邮件是一种异步通信媒介，电子邮件有三个重要的组成部分：

1. 用户代理

   允许用户阅读、回复、转发、保存、撰写报文

2. 邮件服务器

3. 简单邮件传输协议（SMTP）

   主要的应用层协议，使用 TCP 可靠数据传输服务

   SMTP 有两个部分：发送方的客户端，收信方的服务端；一般来说每台邮件服务器既运行客户端也运行服务端（因为也能发信。

   SMTP  一般不使用中间邮件服务器发送邮件，即使这两个邮件服务器位于地球的两端也是如此，两台邮件服务器是直接连接的。

   SMTP  被设计成从一台主机推送到另一台主机（HTTP 是拉）

如果 A 要给 B 发邮件，一般来说，首先 A 使用代理进行 SMTP 发送给自己的邮件服务器，然后邮件服务器作为客户端使用 SMTP 发送给 B 的邮件服务器，对方也是如此，这还是因为 SMTP 一般是直连的。

代理不能通过 SMTP 来获取报文，因为获取报文是一个拉操作，而 SMTP 是一个推协议，这就需要引入一个特殊的邮件访问协议来解决这个问题，该协议将报文传送给本地 PC，比如流行的协议有：POP（一般不会干扰邮件服务器的状态） 和 IMAP（会同步给邮件服务器）。

- POP3

  当代理（客户）打开一个到邮件服务器的链接 110 后，POP3 就开始工作了。

  POP3 也可以通过指令来进行同步邮件服务器。

  POP3 协议没有给用户提供任何创建远程文件夹并为报文指配文件夹的功能（所以有了 IMAP）

- IMAP

  它比 POP3 有更多的特色，也比 POP3 复杂的多。

  IMAP 的另一个重要的特性是它具有允许用户代理获取报文组件的命令（简单理解为获取报文的一部分内容，而并不是所有的邮件）

- 基于WEB的电子邮件

  获取邮件使用的是 HTTP 而不是 POP3 或者 IMAP 协议。

  发送邮件使用的是 HTTP 而不是 SMTP，但是邮件服务器直接的发送使用的还是 SMTP。

---

## DNS

必要条件：

1. 一个由分层的 DNS 服务器实现的分布式数据库
2. 一个使得主机能够查询分布式数据库的应用层协议

DNS 协议运行在 UDP 之上，使用 53 号端口，它是应用层协议。

DNS 不是一个直接和用户打交道的应用，DNS 通过采用位于网络边缘的客户和服务器，实现了关键的名字到地址的转换功能。

想获得的 IP 地址通常就缓存在一个“附近的”DNS 服务器中，有助于减少 DNS 的网络流量和 DNS 的平均时延。

DNS 的特点注定是要使用分布式的设计方案，并且**以层次方式组织**，没有一台 DNS 服务器拥有因特网上所有的主机映射。

根据 DNS 协议的特点，根域名服务器地址的数量被限制为 13 个。幸运的是，采用任播技术架设镜像服务器可解决该问题，并使得实际运行的根域名服务器数量大大增加。截至2017年11月，全球共有800台根域名服务器在运行。截至2017年10月9日，一共记录了 1542 个顶级域，文件的总大小也不过 2M。

从理论上讲，**任何 DNS 查询既可以是迭代的也能是递归的**。实践中，从请求主机到本地 DNS 服务器的查询是递归的（以本地 DNS 服务器的名义获得映射），其余的查询是迭代的（回答都是直接返回给本地 DNS 服务器的）。

可以使用 nslookup 来进行手动查询。

由于缓存和数量（以及分组过滤）的关系，对 DNS 服务器进行 DDos 攻击一般来说效果并不明显，但是其他方式，比如中间人攻击，攻击者截获来自主机的请求并返回伪造的回答（诱使其他 DNS 服务器在缓存中存储伪造的记录），一般来说，这种攻击难以实现，因为要拦截分组或遏制住服务器，GFW 应该可以。也就是说 DNS 服务器有很强的健壮性。

---

## P2P

- 文件分发：

  从单一服务器向大量主机（称为对等方）分发一个大文件。

  P2P 文件分发中，每个对等方能够重新分发它所有的该文件的任何部分，从而在分发过程中协助该服务器，流行的 P2P 文件共享协议是 BitTorrent

  对于 P2P 体系结构，最小分发时间不仅总是小于 客户-服务器 体系结构的分发时间，并且对于任意的对等方数量 N，总是小于 1 小时，因此具有 P2P 体系结构的应用程序是可以进行自扩展的。

- 分布式散列表（DHT）：

---

## 运输层

运输层最重要的两个协议 TCP 和 UDP。

**运输层协议是在端系统中而不是在路由器中实现的**（可能会把报文划分为较小的块，每一块加上运输层首部，然后传递给网络层）。

网络层提供了主机之间的逻辑通信，而运输层为运行在不同主机上的进程之间提供了逻辑通信。

运输协议能够提供的服务常常受制于底层网络层协议的服务模型，**但是即使网络层协议是不可靠的（分组丢失、篡改、冗余），运输层协议也能为应用程序提供可靠的数据传输服务**；即使网络层不能保证报文段的机密性，运输层协议也能使用加密来确保应用程序的报文不被入侵者读取。

### TCP

通过使用流量控制、序号、确认和定时器，确保正确的、按次序的将数据从发送进程交付给接收进程。

多路分解：将运输层报文段中的数据交付到正确的套接字的工作；

多路复用：源主机从不同的套接字中收集数据块，并为每个数据块封装上首部信息（用于以后的分解）从而生成报文段，然后将报文段传递到网络层的工作。

主机上的每一个套接字能够分配一个端口号，当报文到达主机时，运输层检查报文段中的目的端口号，将其定向到相应的套接字。

可靠传输中，使用的 肯定确认（ACK）和否定确认（NAK），理论上这些分组只需要一个比特长就可以表示了（0和1）

这里还要考虑 ACK和NAK受损的可能性，解决这个问题可以进行编号，然后因为有了编号可以把 NAK 去掉了，配合超时、丢失重发机制来保证可靠传输，一般来说还会使用流水线的模式来提高效率。

TCP 也是采用超时/重传来处理报文段丢失的问题。