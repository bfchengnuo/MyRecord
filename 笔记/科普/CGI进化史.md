# CGI进化史

CGI 即 **Common Gateway Interface**，译作“**通用网关接口**”。它的主要目的就是解决人们对“动态网站”的诉求。

简单来说，当一个请求发送到 Web 服务器后，Web 服务器发现如果请求的是静态资源就直接读取硬盘文件返回了；如果发现是动态资源，会根据配置寻找对应的 CGI 程序，然后将请求转发给 CGI，CGI 处理完成后把结果进行拼装成静态资源返回给 Web 服务器，然后 Web 服务器就可以给客户端响应了。

## 背景知识

先来简单解释一下这几个名词吧

- 通用（Common）
  虽然我们听说过 Java 的 Servlet，Python 的 WSGI。但其实 Java、Python 都是支持 CGI 的，不仅如此，其他我们所熟知的语言大都也都支持。
  理论上来说，所有支持标准输出，支持获取环境变量的编程语言都能用来编写 CGI 程序。
- 网关（Gateway）
  这里更形象的叫法是“**协议翻译机**”。
  通常与网关输入输出两端通信使用的是不同的协议。即一方是 HTTP 协议，另一方可能是其他协议，比如企业内部的自定义协议。CGI 程序既是如此，也算是一种自定义协议。
  CGI 程序通常部署到 Web 服务器（如 Apache）上，Web 服务器然后调用 CGI 程序。
- 接口（Interface）
  确切而言是“接口协议”，所谓协议，既是通信双方或多方都共识并遵守的一套规则。

在 Web 服务器调用 CGI 之前，会把各类 HTTP 请求中的信息以**环境变量**的方式写入 OS。**CGI 程序本质是 OS 上一个普通的可执行程序**，它通过语言本身库函数来获取环境变量，从而获得数据输入。

除环境变量外，另外一个 CGI 程序获取数据的方式就是**标准输入（stdin）**；

而 CGI 如何构造出数据（比如 HTML 页面）返回给浏览器呢？其实 CGI 本身只要向标准输出去写入数据即可。
因为 Web 服务器已经做了重定向，将标准输出重定向给 Web 服务器的与浏览器连接的 socket。

当然，CGI 不止要复杂静态 HTML，响应头也需要它来拼装。

## 发展-FCGI

每次 HTTP 请求 CGI，Web 服务器都有启动一个新的进程去执行这个 CGI 程序，即颇具 Unix 特色的 fork-and-execute。当用户请求量大的时候，这个 fork-and-execute 的操作会严重拖慢 Web 服务器的性能。

时势造英雄，FastCGI（简称 FCGI）技术应运而生。简单来说，其本质就是一个常驻内存的进程池技术，由调度器负责将传递过来的 CGI 请求发送给处理 CGI 的 handler 进程来处理。
在一个请求处理完成之后，该处理进程不销毁，继续等待下一个请求的到来。

当然 FCGI 其实也并不是什么惊世骇俗的创意，很容易联想到的解决思路。
**资源池是后台性能优化中的常见套路**。Java 发明的 Servlet 技术也是一种常驻内存的网关通信技术，只不过它采用的是多线程而非进程。

---

Restful 风格 API 的出现，以及 Vue 之类的页面技术一定程度让 CGI 获得了**续命**。页面的渲染工作从后端转移到了前端，后端只需要单纯的提供必要的数据即可，简洁高效。

> 除了 FCGI 外，还有 SCGI（Simple CGI），也是作为 CGI 的替代协议而产生的，但他与 FCGI 更像；
> 另外呢，SCGI 在每次完成 HTTP 应答之后都立即关闭 HTTP 连接，有点张小龙“**用完即走**”的意思。
> 这个简单的协议更符合 Restful API 的理念需要。但是名气不大哈。

## 缺陷

CGI 程序有一不大不小的缺陷，缺乏 URL 路由的功能，基本上一个 CGI 都是独立提供给外界访问，一个 CGI 就是独立的可执行程序。
因此**不仅 CGI 的 URL 比较丑陋，而且容易暴露真实路径**。

不过，一般都会有上层 Web 服务器做路由，例如 Apache 或者 Nginx。

## 补充

现在大部分的网站其实都在尽量的将不敏感的计算转移到前端，减轻后端的压力，这时候 JS 的好处就体现出来了，话说现在有很多的逻辑也确实都是在用 JS 写。

## 参考

https://zhuanlan.zhihu.com/p/25013398