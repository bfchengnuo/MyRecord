# 鉴别邮件伪造

伪造邮件不是啥新鲜事，毕竟 SMTP 协议并没有规定认证相关的东西，有编程基础或者网络基础的应该都玩过。

基础的概念就不多说了，主要看如何鉴别，然后选一个好的邮箱是非常重要的，目前我觉得最好的就是 Gmail 了，如果能用的话。

## mail_from 和from 的区别

mail_from： 是信封上的发件人，由`[前缀@域名]`组成，是实际发件人（当然原始邮件中并不会标示 mail_from 这个名字，例如 Gmail 会以 Sender 标识）。

from： 信封内容里的发件人。 也就是我们平时查看邮件上显示的，这个其实是可以随意改的。

但是如果 mail_from （实际发件人） 和 from （宣称的发件人） 不一致，则收到的邮件会显示 本邮件由`<实际发件人>代发`，以提醒收件人两者的不同，不过不同的邮箱对这个的判断规则不一样，例如同一个域名不同主机就不会显示。

QQ 邮箱的话，界面是真的简洁，但是简洁到连查看原始邮件都没有，只能下载 eml，手动查看，安全性上也不是很好，给国外发邮箱有几率会丢。。。

一般情况，原始邮件中的 Received 代表真实发件人（自己对一下域名与 IP），但是这个也可能伪造，伪造也只是会增加多个 Received 信息，引起混乱，如果有多个，要注意区别，可以根据 Message-Id 的后缀对比是不是“发件人”的域。

> 虽然 Received 头可以伪造，但是新的 Received 头会添加在消息的头部，所以，如果存在伪造的 Received，那么它总是在后面。
>
> 若有多个 Received，第一个 Received 中 是正规的（网易、腾讯等等） SMTP 服务器 转发过的，那么肯定是经过验证的合法用户才能转发过来，因为这些厂商都不会开匿名转发，此时只需要看 IP 与宣称身份是否一致，一致就 OK。

另外，也可以尝试回复一下邮件，这样真实发件人就知道了，对比一下和显示的发件人是否一致，不一致就要小心了

---

即使不显示代发，也要小心，某些客户端或者在基于魔改 SMTP 下，是有可能绕过检测的，不过你查看下原始邮件，对比一下，这个是造不了的。

## SPF

如果在 Gmail 查看原始邮件，这些都会有，并且有链接帮你了解什么是 SPF。

SPF 其实就是一条 DNS 的 TXT 的记录，其记录值就是 SPF 的内容，通过它就能简单的校验发信人的地址与真实 IP 到底对不对。

## DKIM

国外用的比较多，国内不多，比如腾讯邮箱默认就不支持这个，从 Gmail 发出的邮件就带有 DKIM 签名。

它的目的主要用来**保证邮件的完整性**，避免钓鱼。与 SPF 一样也做 Sender authentication，但 DKIM 做的比 SPF 更复杂，DKIM 会对邮件头及正文进行签名，没有私钥下，邮件被假冒或篡改后，就会与邮件头签名不一致，从而防止这样的情况。

> DKIM 使用一对密钥（一个私钥和一个公钥）来验证邮件。
>
> 私有域名密钥会向所有来自您 Gmail 网域的外发邮件添加加密标头。
>
> 系统会将匹配的公钥添加到您 Gmail 网域的域名系统 (DNS) 记录中。收到来自您网域的邮件的电子邮件服务器会使用此公钥解密邮件标头，来验证邮件来源。
>
> 当您在 Gmail 中启用电子邮件身份验证时，DKIM 就会开始加密外发邮件的标头。

DKIM 签名是先对内容（BODY）部分 HASH，然后把这个 BODY HASH 放到 HEADER 里面，再对头部做签名。头部也不是所有字段都要签名，只有一些常用的字段，或者比较有意义的。

接收方则通过 DNS 查询得到公开密钥后进行验证， 验证不通过，则认为是垃圾邮件，所以 DKIM 不仅仅可以防止垃圾邮件，还可以防止邮件内容被篡改。

一般来说，发送方会在电子邮件的标头插入 DKIM-Signature 及电子签名信息。而接收方则通过 DNS 查询得到公开密钥后进行验证。

> DKIM 签名可提高电子邮件安全性，并有助于防止电子邮件遭到仿冒。我们建议您对所有外发邮件使用自己的 DKIM 密钥。
>
> 如果您未生成自己的 DKIM 域名密钥，则 Gmail 会使用以下默认的 DKIM 域名密钥签署所有外发邮件：d=*.gappssmtp.com。
>
> 系统不会使用默认 DKIM 密钥为 mail.google.com 以外的服务器发送的邮件签名。

## DMARC

Gmail 支持使用基于网域的消息认证、报告和一致性 (DMARC) 验证机制，以防范此类垃圾邮件。您可以使用 DMARC 定义政策，决定 Gmail 如何处理看似来自您网域、实为垃圾内容的邮件。

您的用户无需执行任何操作，因为 Gmail 会执行 DMARC 检查。

如果没有通过，可能会放入垃圾邮件中，或者拒收，果然还是我大 Gmail 强。

## 参考

https://www.anquanke.com/post/id/86375

https://www.tr0y.wang/2018/09/26/email-hacker/index.html