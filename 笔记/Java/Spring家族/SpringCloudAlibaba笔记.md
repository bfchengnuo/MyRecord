# SpringCloudAlibaba笔记

一开始，我是想仔细写一下，但是后来感觉又没意思，都是堆示例代码，最后用的时候还是 Google 一把，并且毕竟是阿里全家桶，官方中文资料很全，写的也不错，例子很多，更感觉没啥必要，于是就简单列列，用的多了自然就熟悉了。

核心：

- Nacos
  服务注册和配置中心；简单说就是 Eureka + Config + Bus
- Sentinel
  服务熔断与限流
- Seata
  分布式事务

官方文档地址：https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html

以及，贴心的阿里生怕你上手难，特意给你搞了个 [Alibaba Initialize](https://start.aliyun.com/) 生成后有 demo，区别于 SB，你只需要做减法即可。

> SpringCloudNetflix 进入维护模式，这给 SpringCloudAlibaba 很大机会，站在巨人的肩膀上，相信还是会对我们更加友好。

## Nacos

相比 Eureka，易用性好太多了，不需要创建什么工程，直接从官网下 jar 包执行即可，默认的管理界面端口也很霸气，8848，默认用户名和密码都是 nacos。

自带 Web 管理界面真的很贴心，并且自带负载均衡（传递依赖 ribbon），默认自然是轮训。

Nacos 默认虽然是 AP 模型，但是野心并不小，要做全覆盖，也就是虽然默认 AP，但是支持你切换，你可以切换到 CP，满足各种场景。

对于临时不需要持久化的实例注册，选择 AP，否则使用 CP。大多数下还是 AP 用的多。

---

不论是作为配置中心还是注册中心，官网的手册写的太详细了，完全没有必要再 copy 一遍。

业务类需要动态刷新就加上 @RefreshScope 注解，这个注解也不是第一次见，参考 Config 都是一样的。

---

Nacos 的基本使用很简单，关键在于配置集群与持久化，也就是入库。默认使用的是内嵌数据库 derby，生产环境肯定要配置成自己的，要不然就集群的数据一致性都难弄。

官方地址：https://nacos.io/

## Sentinel

保护你的服务的，主要应对流量攻击，跟 Hystrix 一样。

既然是后来的，那么必然吸取前人的经验，并且有自己的特点，使用上，肯定 Sentinel 会更加方便，更加细化了。

Sentinel 也是直接独立出来，服务端直接 jar 运行，提供 Web 管理界面。

文档：https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D

---

类似的，在熔断后，提示内容可以自定义，从 HystrixCommand 到 **@SentinelResource**，就是换个名字，也做为服务降级用。

整体的限流思想采用是 try...catch 的思路。

### 流控

类型分为 QPS 与线程流控；QPS 比较好理解，就是超过请求数直接返回失败，直接不会进去。

线程与 QPS 的区别是，请求可以进入，但是如果上一个（看配置数）请求还没处理完，后来的就会失败，如果正好处理完了，就没问题。

---

流控模式：

- 直接

- 关联模式：其他资源触发阈值，限流自己。例如支付与订单接口。
- 链路

---

流控效果：

- 快速失败
- 预热：多用于秒杀，在一定时间内慢慢提升，其余快速失败处理。
- 排队（匀速）：严格控制间隔时间，匀速器模式，例如 QPS 为 1 就是一秒一个，为 2 就是一秒两个。

### 熔断降级

降级策略：

- RT（平均响应时间，秒级），前置条件 QPS >= 5
- 异常比例，前置条件 QPS >= 5
- 异常数，按分钟统计，所以时间窗口必须大于等于 60s

然后还需要设置一个时间窗口，也就是多少时间后尝试恢复。

PS：Sentinel 没有半开状态。

### 热点规则

在 Controller 中使用 @SentinelResource 注解配置兜底方法（如果不配默认跳错误页面），它是根据请求参数来进行限流，所以叫热点；在配置的时候填的是参数的索引，这个对应的是代码里的方法参数，不是 URL 的位置。

更高级的，可以配置当请求参数是特殊值时，不进行限流，这就是例外情况。

### 持久化

上面配置的一些流控规则都是临时的，当服务下线后对应的规则也会自动删除，Sentinel 的规则持久化很巧妙，假设你用了 Nacos，那边已经做了持久化，这边其实没必要再搞一份，直接存到 Nacos 的配置里就好了。

[参考文档1](https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95)

[参考文档2](https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E6%94%AF%E6%8C%81)

## Seata

分布式事务，或者说为了解决分库后数据一致性的问题，立足点就是全局事务唯一 ID 的生成，另外三个名词：

- **TC - 事务协调者**

  维护全局和分支事务的状态，驱动全局事务提交或回滚。
  可理解为 seata 服务端。

- **TM - 事务管理器**

  定义全局事务的范围：开始全局事务、提交或回滚全局事务。
  可理解为标注注解的业务方法。

- **RM - 资源管理器**

  管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。
  可理解为单个数据库。

以上所谓 1+3 核心，规范还是按照 二阶段提交，默认采用 AT 的模式。

![Overview of a global transaction](https://img.alicdn.com/tfs/TB14Kguw1H2gK0jSZJnXXaT1FXa-853-482.png)

简要流程：

1. TM 向 TC 申请全局事务 XID（申请全局事务）
2. XID 会在微服务调用链路中传播
3. RM 向 TC 注册分支事务（根据 XID，受此管理）
4. TM 向 TC 发起针对 XID 的提交或者回滚的提议
5. TC 调度 XID 下面的分支事务完成提交或者回滚

以上就是主要流程，对比 二阶段提交 看就比较清晰了，流程是这样，那么具体如何保证两阶段的执行，这就是 Seata 负责的，其中包含很多补偿机制，这才是复杂的。

原理虽然复杂，但是使用非常简单，日常只需要两个注解 **@GlobalTransactional** 和 **@Transactional** （Spring 本地事务）就能解决大部分问题。

PS：搭建过程中，记得在每个数据建立 Seata 指定的回滚记录表。

既然是阿里的，当然阿里全家桶，注册用 Nacos，存储还是用数据库。另外可以加各种高可用那一套，保证分布式事务的『安全』

---

我感觉官方写的文档很好，并且还是中文，真的是学习分布式事务的不错资料。

官网：https://seata.io/zh-cn/

---

Seata 从 19 年初开始开源，可以说是阿里云 GTS 的开源版（免费版），毕竟，还是那啥，想要更稳定的使用，就是买它家的服务了。

## 补充

SC 版本选型：https://start.spring.io/actuator/info