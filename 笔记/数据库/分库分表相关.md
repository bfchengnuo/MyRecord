# 分库分表相关

MySQL 单表数据达到多少时才需要考虑分库分表？有人说 2000 万行，也有人说 500 万行。

曾经在中国互联网技术圈广为流传着这么一个说法：MySQL 单表数据量大于 2000 万行，性能会明显下降。

事实上，这个传闻据说最早起源于百度。具体情况大概是这样的，当年的 DBA 测试 MySQL性能时发现，当单表的量在 2000 万行量级的时候，SQL 操作的性能急剧下降，因此，结论由此而来。然后又据说百度的工程师流动到业界的其它公司，也带去了这个信息，所以，就在业界流传开这么一个说法。

再后来，阿里巴巴《Java 开发手册》提出**单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表**。对此，有阿里的黄金铁律支撑，所以，很多人设计大数据存储时，多会以此为标准，进行分表操作。

---

那么为什么超过一定的量性能就会下降？

事实上，这个数值和实际记录的条数无关，而与 MySQL 的配置以及机器的硬件有关。因为，MySQL 为了提高性能，会将表的索引装载到内存中。InnoDB buffer size 足够的情况下，其能完成全加载进内存，查询不会有问题。

但是，当单表数据库到达某个量级的上限时，导致内存无法存储其索引，使得之后的 SQL 查询会产生磁盘 IO，从而导致性能下降。

当然，这个还有具体的表结构的设计有关，最终导致的问题都是内存限制。这里，增加硬件配置，可能会带来立竿见影的性能提升哈。

---

那么何时分库分表？

我比较赞同的一个观点：需要结合实际需求，不宜过度设计，在项目一开始不采用分库与分表设计，**而是随着业务的增长，在无法继续优化的情况下，再考虑分库与分表提高系统的性能**。

对此，阿里巴巴《Java 开发手册》补充到：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。

## 如何分库分表

进程肯定是循序渐进的，从单表到单库分表，再到多库分表。

这主要是个经验活，目前我还没有遇到这种情况，目前都是理论基础，了解个概念，下面写的也不是很详细，之后再说吧。

TBD 待补充。

分表的常见策略：

### Range

按照范围划分，比如我们可以将某张表的创建时间按照日期划分存为月表；也可以将某张表的主键按照范围划分；

这样的分表适合需要对数据做归档处理，比如系统默认只提供近三个月历史数据的查询功能，这样也方便操作；只需要把三月之前的数据单独移走备份保存即可。

- 好处是自带水平扩展，不需要过多干预。
- 缺点是可能会出现数据不均匀的情况（比如某个月请求暴增）。

### Hash

分表算法可以采用主流的 `hash+mod` 的组合。

这是一个经典的算法，大名鼎鼎的 `HashMap` 也是这样来存储数据。

当然也可以使用 Range + Hash 的方式来做。

### 数据迁移

数据迁移是很头疼的一个问题，一般来说，为了不影响正常使用，会先在程序里写一个判断；

判断数据是否是新数据，如果是就直接操作新的分表；如果不是则操作老表；

等一段时间后大部分的操作都是对新表，这时候再进行迁移，最后移除路由。

## 参考

https://segmentfault.com/a/1190000019565641

https://crossoverjie.top/2019/07/24/framework-design/sharding-db-03/